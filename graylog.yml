# TODOs
# X Download Docker image
# X Setup graylog-docker-role
# - create /srv/docker/graylog for persistent data. Maybe move to LVM and deploy
# --- plugin directly.
# X setup nginx reverse proxy to graylog.
# - All other nodes:
# -- Automatate setup nginx logformat and log to syslog
# -- Automate setup syslog forwarder to Graylog
# --- Need to open ports for private subnets
# -- Automate setup pharos gelf gem and forward to logs (needs production ready setup)
# --- Need to open ports for private subnets
# - Verify files are still being written
# -- nginx: can take two log statements and log simultaneously
# - What about logretention?
# - nsq: https://marketplace.graylog.org/addons/775319b1-4737-42af-ae05-f8089727e7b8
# - nicetohave: https://marketplace.graylog.org/addons/962af1ae-dee3-400a-9207-7af2188fca49

-   hosts:
      - tmp-ebs-test2
    vars_files:
      - "group_vars/vault.yml"
    vars:
        playbook_name: 'graylog'

        # NGINX Webserver
        install_passenger: false
        content_security_policy: false
        install_reverse_proxy: true

        nginx_reverse_proxy_proxies:
          - config_name: graylog
            backend_name: graylog-web-backend
            backends:
              - localhost:9000
            # Currently only one supported due to certbot limit. Can't extract
            # multiple domains and pass into multiple '-d' params.
            domains:
              - logs.aptrust.org
            extra_params:
              - "proxy_set_header X-Graylog-Server-URL https://$server_name/api/;"
              - "proxy_set_header X-Forwarded-Host $host;"
              - "proxy_set_header X-Forwarded-Server $host;"
              - "proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;"

    roles:
      #  - {role: common, tags: common}
      - {role: cd3ef.nginx, tags: nginx}
      - {role: franklinkim.docker-compose, tags: docker-compose}
      - {role: mongrelion.docker, tags: docker}

    tasks:
      #  docker_service to use docker compose files

    - file:
        path: /srv/docker/graylog
        owner: ubuntu
        group: ubuntu
        mode: 0755
        state: directory
      tags: makedir

    - template:
        src: roles/docker.graylog/templates/docker-compose.yml
        dest: /srv/docker/graylog
      tags: dockserv

    - docker_service:
        project_src: /srv/docker/graylog
      register: output
      tags: dockserv

    - debug:
        var: output
