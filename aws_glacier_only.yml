# This simple script creates Glacier buckets for the APTrust Glacier-only service.
#
# TODO: Think more about datastructure and how to incorporate all buckets.
# Would require another field used as a condition for applying lifecycle rules
# (not all buckets require Glacier archiving.
# aws s3 ls |awk '{print $3}' >> ansible-playbooks/aws_glacier_only.yml
---
  - name: Instantiating an EC2 Instance
    hosts: localhost
    connection: local
    gather_facts: False
    become: no

    vars:
      orgtype: 'apt'

      aptrust_s3_buckets:
        - name: "aptrust.preservation.glacier.va"
          region: 'us-east-1'
        - name: "aptrust.preservation.glacier.oh"
          region: 'us-east-2'
        - name: "aptrust.preservation.glacier.or"
          region: 'us-west-2'
        - name: "aptrust.test.preservation.glacier.va"
          region: 'us-east-1'
        - name: "aptrust.test.preservation.glacier.oh"
          region: 'us-east-2'
        - name: "aptrust.test.preservation.glacier.or"
          region: 'us-west-2'


    tasks:

      - name: Create S3 buckets
        s3_bucket:
          name: "{{item.name}}"
          region: "{{item.region| default('us-east-1')}}"
          state: present
          tags:
            orgtype: "{{orgtype}}"
        loop: "{{aptrust_s3_buckets}}"

      - name: Apply Glacier Lifecycle Policy
        s3_lifecycle:
          name: "{{item.name}}"
          region: "{{item.region}}"
          status: enabled
          state: present
          storage_class: glacier
          transition_days: 0
          rule_id: ArchiveToGlacier
        loop: "{{aptrust_s3_buckets}}"

