---
- include: user.yml
  when: solr_create_user

- name: Set solr_filename for Solr 5.x.
  set_fact:
    "solr_filename=solr-{{ solr_version }}"
  when: "solr_version.split('.')[0] == '5'"

- name: Set solr_filename for Solr 4.x.
  set_fact:
    "solr_filename=solr-{{ solr_version }}"
  when: "solr_version.split('.')[0] == '4'"
  tags: solrnew, solr_dir

- name: Download Solr.
  get_url:
    url: "{{ solr_mirror }}/lucene/solr/{{ solr_version }}/{{ solr_filename }}.tgz"
    dest: "{{ solr_workspace }}/{{ solr_filename }}.tgz"
    force: no
  tags: solrnew

- name: Set solr_dir
  set_fact: solr_dir="{{solr_workspace}}/{{solr_filename}}"
  tags: solr_dir

- name: Unarchive solr
  command: >
    tar -xvf {{solr_workspace}}/{{ solr_filename}}.tgz
    chdir={{ solr_workspace }}
    creates={{solr_workspace}}/{{solr_filename}}
  tags: solrnew

- name: Copy Solr components into place
  shell: >
    cp -rnv {{ item.src }} {{ item.dest }}
    creates={{ item.creates }}
  with_items:
    # Solr example configuration and war file
    - src: "{{ solr_dir }}/dist/{{solr_filename}}.war"
      dest: "{{ solr_install_path }}/solr.war"
      creates: "{{solr_install_path}}/solr.war"

    # Solr log4j logging configuration
    - src: "{{ solr_dir }}/example/lib/ext/*"
      dest: "/var/lib/tomcat7/shared/"
      creates: "/var/lib/tomcat7/shared/log4j-1.2.16.jar"

    # Solr log4j.properties
    - src: "{{ solr_dir }}/example/resources/log4j.properties"
      dest: "/var/lib/tomcat7/shared/classes/log4j.properties"
      creates: "/var/lib/tomcat7/shared/classes/log4j.properties"
      notify: restart tomcat
  tags: solrnew

- name: Copy Solr.war to /var/lib/tomcat7/webapps
  command:
    "cp -nv {{ solr_workspace}}/{{solr_filename}}/dist/{{solr_filename}}.war {{solr_install_path}}/solr.war"
  when: not solr_war_file.stat.exists

  # - name: Ensure Solr install files are owned by the solr_user.
  # file:
  #  path: "{{ solr_install_path }}"
  #  owner: "{{ solr_user }}"
  #  group: tomcat7
  #  recurse: yes
  # when: not solr_war_file.stat.exists

- include: solr-home.yml
- include: init-script.yml
