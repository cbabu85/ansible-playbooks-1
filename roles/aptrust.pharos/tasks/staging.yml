---
# Staging environment deployment
# Every new deploy for the staging environment should
# - Destroy running Docker containers if exists (DOES THIS ALREADY in docker.yml)
# - Destroy old Staging DB, if exists
# - Recreate Staging DB from latest demo/prod db backup (env should be passed in as variable but may default to demo)
# - Recreate/Deploy Pharos Docker containers.

  - name: Make sure Docker services are shutdown and volumes removed.
    command: sudo docker-compose down --remove-orphans -v
    args:
       chdir: "{{docker_app_path}}"
    tags: dockserv

  - name: Start Postgres container with initdb
    command: sudo docker-compose up -d  db
    args:
       chdir: "{{docker_app_path}}"
    tags: dbdump

  - set_fact: source_env=demo

  - set_fact:
       pharos_src_db_pwd: "{{vault_pharos_demo_db_pwd}}"
       pharos_src_db_host: "{{vault_pharos_demo_db_host}}"
       pharos_src_db_user: "{{vault_pharos_demo_db_user}}"
       pharos_src_db: pharos_demo
    when: source_env | search("demo")
    tags: always

  - set_fact:
       pharos_src_db_host: "{{vault_pharos_prod_db_host}}"
       pharos_src_db_user: "{{vault_pharos_prod_db_user}}"
       pharos_src_db_pwd: "{{vault_pharos_prod_db_pwd}}"
       pharos_src_db: pharos_production
    when: source_env | search("prod")
    tags: always

  - name: Docker pg_dump RDS database
    #    shell: sudo docker-compose run --rm -e PGPASSWORD={{pharos_src_db_pwd}} -v /data/pharos/pgdata:/pgdata db bash -c "pg_dump -h {{pharos_src_db_host}} -p 5432 -Fc -C -O -U {{pharos_src_db_user}} {{pharos_src_db}} > /pgdata/{{pharos_src_db}}.dump"
    shell: sudo docker-compose exec db bash -lc "PGPASSWORD={{pharos_src_db_pwd}} pg_dump -h {{pharos_src_db_host}} -p 5432 -Fc -C -O -U {{pharos_src_db_user}} {{pharos_src_db}} > /{{pharos_src_db}}.dump"
    become: true
    args:
       chdir: "{{docker_app_path}}"
       executable: /bin/bash
    tags: dbdump2

  - name: Create pharos src db DB to connect to later
    shell: sudo docker-compose exec -u postgres db psql -c "{{item}}"
    with_items:
       - "DROP DATABASE IF EXISTS pharos_staging;"
       - "DROP DATABASE IF EXISTS {{pharos_src_db}};"
       - "CREATE DATABASE {{pharos_src_db}};"
    args:
       chdir: "{{docker_app_path}}"
    tags: dbdumprestore

  - name: Restore pharos_demo.dump to local psql container
    command: sudo docker-compose exec db bash -lc "sleep 2 && pg_restore --verbose --no-acl --no-owner -U postgres -d {{pharos_src_db}} /{{pharos_src_db}}.dump"
    args:
       chdir: "{{docker_app_path}}"
    tags: dbdumprestore

    # Defining user as superuser since finding and setting correct privileges
    # on schema and tables is a pain. Won't matter as much anyways since psql
    # will only have pharos staging db.
  - name: Create DB and User permissions
    command: sudo docker-compose exec -u postgres db psql -c "{{item}}"
    with_items:
       - "CREATE USER {{pharos_db_user}} WITH PASSWORD '{{pharos_db_pwd}}' SUPERUSER"
       - "ALTER DATABASE {{pharos_src_db}} RENAME TO pharos_staging"
       - "ALTER DATABASE pharos_staging OWNER TO {{pharos_db_user}};"
       # - "GRANT ALL PRIVILEGES ON DATABASE pharos_staging to {{pharos_db_user}};"
       # - "GRANT ALL PRIVILEGES ON SCHEMA public to {{pharos_db_user}};"
       # - "GRANT ALL PRIVILEGES ON SCHEMA public to public;"
       # - "GRANT ALL ON ALL TABLES IN SCHEMA public TO {{pharos_db_user}};"
       # - "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO {{pharos_db_user}};"
    args:
       chdir: "{{docker_app_path}}"
    ignore_errors: True
    tags: dbdump

# Next should startup all services again.
#  - name: Start docker containers from compose
#    command: docker-compose up -d chdir="{{docker_app_path}}"
#    tags: dockserv2
