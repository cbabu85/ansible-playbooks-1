---

# Check if GO is installed, if not fail. Alternatively include go role in meta.

# Install required packages
# Needed for supervisor?
- name: Install required packages
  become: yes
  apt: pkg="{{item}}" state=present update_cache=yes
  with_items:
      - python-pip
      - libmagic-dev
      - git
      - bzr
      - mercurial
      - curl
  environment:
     DEBIAN_FRONTEND: noninteractive

# Set AWS Credentials as ENV
# TODO: Consider using separate creds for staging and prod S3 access.

- name: Set AWS ACCESS Credentials
  no_log: true
  lineinfile: >
    dest="/home/{{system_default_user}}/.profile"
    state=present
    line="{{item}}"
    insertafter=EOF
  with_items:
    - "export AWS_ACCESS_KEY_ID={{aws_go_user}}"
    - "export AWS_SECRET_ACCESS_KEY={{aws_go_pwd}}"

# TODO: Mount EBS volumes or create directories if VirtualBox.


# Checkout Exchange repo
# This may be done using ansistrano. Alternatively we can just update the current version and restart supervisor services first. Is rollback necessary? Probably.

- name: Checkout exchange repo
  become_user: "{{system_default_user}}"
  shell: "go get -d github.com/APTrust/exchange/..."
  environment: "{{go_env}}"
  register: checkout
  tags: buildgo

# go install exchange binaries.
- name: Build and install go binaries
  shell: "go install $(glide novendor)"
  args:
    chdir: "{{goapp_src_path}}"
  environment: "{{go_env}}"
  when: checkout.changed
  register: build_result
  failed_when: "'no buildable Go source files' not in build_result.stderr"
  changed_when: "'no buildable Go source files' not in build_result.stderr"
  tags: buildgo

# Note: This seems like a weak reference. Refactor this.
# Get list of compiled go binaries
- name: Get list of compiled go binaries
  shell: "ls $GOPATH/bin | grep -v apt_bucket_reader"
  register: dir_out
  tags: listfiles

- name: Create the Supervisor config file for Exchange
  template: src=supervisor.conf.j2
            dest=/etc/supervisor/conf.d/{{ item }}.conf
  with_items: "{{dir_out.stdout_lines}}"
  tags: listfiles

# TODO: Copy supervisorctl templates in etc, if already exist skip.

# TODO: Create a supervisor template.

#- name: Re-read the Supervisor config files
#  command: supervisorctl reread

#- name: Update Supervisor to add the app in the process group
#  command: supervisorctl update
# TODO: Restart supervisor group gracefully

# Tell Andrew not to use bash_profile but .profile or bashrc.
# Ask Andrew if we want to use supervisor instead of bash scripts? Prod env it would be useful. Dev env might not be as useful. Do we want to keep scripts like in bagman?
#
