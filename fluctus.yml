---
  - hosts: vagrant
#    Might not be needed if using ansible-playbooks -b
#    sudo: yes
   vars_files:
      - "group_vars/all.yml"
      - "group_vars/vault.yml"
   vars:
      playbook_name: fluctus

      ## SSL
      ssl_cert: {{ var_ssl_cert }}
      ssl_key: {{ var_ssl_key }}
      ssl_chain: {{ var_ssl_chain }}
      ssl_cert_path: {{ var_ssl_cert_path }}
      ssl_key_path: {{ var_ssl_key_path }}
      ssl_chain_path: {{ var_ssl_chain_path }}

      ## Apache
      apache_vhosts:
        - servername: "{{ ansible_fqdn }}"
          documentroot: "/var/www/{{ playbook_name }}"
          serveradmin: "ops@aptrust.org"
          extra_parameters: |
                # Redirect all http to https per default
                RewriteEngine On
                RewriteCond %{HTTPS} !=on
                RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
      apache_vhosts_ssl:
        - {
            servername: "{{ ansible_fqdn }}"
            documentroot: "/var/www/{{ playbook_name }}"
            serveradmin: "ops@aptrust.org"
            certificate_file: "{{ var_ssl_cert }}",
            certificate_key_file: "{{ var_ssl_key }}",
            certificate_chain_file: "{{ var_ssl_chain }}"
        }
         apache_mods_enabled:
           - rewrite.load
           - ssl.load
        apache_mods_disabled: []
    roles:
      - common
      - apache
      - ssl
